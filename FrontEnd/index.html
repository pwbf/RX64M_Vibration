<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta name="theme-color" content="#480ca7">
	<meta http-equiv="pragma" content="no-cache">
	<meta http-equiv="expires" content="0">
	<meta http-equiv="cache-control" content="no-cache">
	
	<meta property="og:title" content="ASTARC Vibration Chart" />
	<meta property="og:description" content="Vibration Chart Demo Page" />
	<meta property="og:site_name" content="ASTARC Vibration Chart" />
	<meta property="og:url" content="https://vibr.astarc.tk" />
	<meta property="og:type" content="website" />
	<meta property="og:image" content="https://static.res.pwbf.pw/global/img/PFCico.png" />
	
	<title>LeadWell Vibration Monitor System</title>
	
	<link rel="shortcut icon" href="https://static.res.pwbf.pw/global/img/PFCico.png" type="image/x-icon">
	<link rel="apple-touch-icon-precomposed" href="images/apple-touch-icon.png">
	<link rel="stylesheet" href="https://static.res.pwbf.pw/ChartJS2/Chart.min.css">
	<link rel="stylesheet" href="https://static.res.pwbf.pw/uikit3/css/uikit.min.css">
	<link rel="stylesheet" href="https://static.res.pwbf.pw/uikit3/css/crossall.css">
	<link href="https://fonts.googleapis.com/css?family=Noto+Sans+TC&display=swap" rel="stylesheet">
	
	<script src="https://static.res.pwbf.pw/ChartJS2/Chart.min.js"></script>
	<script src="https://static.res.pwbf.pw/jquery/3/jquery-3.5.1.min.js"></script>
	<script src="https://static.res.pwbf.pw/uikit3/js/uikit.min.js"></script>
	<script src="https://static.res.pwbf.pw/uikit3/js/uikit-icons.min.js"></script>
<script>
var uInterval = 20000;
var timeleft = uInterval;
var TDScale = 100;
var TPScale = 2;
var TPDif = 2;

$(document).ready(function() {
	renderChart();
	loadDataPage();
});
setInterval(function(){ loadDataPage(); }, uInterval);
setInterval(function(){ countDownTimer(); }, 100);

Chart.pluginService.register({
      beforeDraw: function(chart) {
        if (chart.config.options.elements.center) {
          // Get ctx from string
          var ctx = chart.chart.ctx;

          // Get options from the center object in options
          var centerConfig = chart.config.options.elements.center;
          var fontStyle = centerConfig.fontStyle || 'Arial';
          var txt = centerConfig.text;
          var color = centerConfig.color || '#000';
          var maxFontSize = centerConfig.maxFontSize || 50;
          var sidePadding = centerConfig.sidePadding || 20;
          var sidePaddingCalculated = (sidePadding / 100) * (chart.innerRadius * 2)
          // Start with a base font of 30px
          ctx.font = "30px " + fontStyle;

          // Get the width of the string and also the width of the element minus 10 to give it 5px side padding
          var stringWidth = ctx.measureText(txt).width;
          var elementWidth = (chart.innerRadius * 2) - sidePaddingCalculated;

          // Find out how much the font can grow in width.
          var widthRatio = elementWidth / stringWidth;
          var newFontSize = Math.floor(30 * widthRatio);
          var elementHeight = (chart.innerRadius * 2);

          // Pick a new font size so it will not be larger than the height of label.
          var fontSizeToUse = Math.min(newFontSize, elementHeight, maxFontSize);
          var minFontSize = centerConfig.minFontSize;
          var lineHeight = centerConfig.lineHeight || 25;
          var wrapText = false;

          if (minFontSize === undefined) {
            minFontSize = 20;
          }

          if (minFontSize && fontSizeToUse < minFontSize) {
            fontSizeToUse = minFontSize;
            wrapText = true;
          }

          // Set font settings to draw it correctly.
          ctx.textAlign = 'center';
          ctx.textBaseline = 'top';
          var centerX = ((chart.chartArea.left + chart.chartArea.right) / 2);
          var centerY = ((chart.chartArea.top + chart.chartArea.bottom) / 2);
          ctx.font = fontSizeToUse + "px " + fontStyle;
          ctx.fillStyle = color;

          if (!wrapText) {
            ctx.fillText(txt, centerX, centerY);
            return;
          }

          var words = txt.split(' ');
          var line = '';
          var lines = [];

          // Break words up into multiple lines if necessary
          for (var n = 0; n < words.length; n++) {
            var testLine = line + words[n] + ' ';
            var metrics = ctx.measureText(testLine);
            var testWidth = metrics.width;
            if (testWidth > elementWidth && n > 0) {
              lines.push(line);
              line = words[n] + ' ';
            } else {
              line = testLine;
            }
          }

          // Move the center up depending on line height and number of lines
          centerY -= (lines.length / 2) * lineHeight;

          for (var n = 0; n < lines.length; n++) {
            ctx.fillText(lines[n], centerX, centerY);
            centerY += lineHeight;
          }
          //Draw text in center
          ctx.fillText(line, centerX, centerY);
        }
      }
    });

function countDownTimer(){
	var timeleftSec = (timeleft/1000).toFixed(1);
	var colorCode = 'rgb('+colorR(timeleftSec)+','+ colorG(timeleftSec)+','+ colorB(timeleftSec)+')';
	configcountdown.options.elements.center.text = timeleftSec;
	configcountdown.options.elements.center.color = colorCode;
	configcountdown.data.datasets[0].data = [timeleft, uInterval - timeleft];
	configcountdown.data.datasets[0].backgroundColor = [colorCode, '#d4d4d4'];
	timeleft -= 100;
	window.TM.update();
}

function colorR(tm){
	return 4.9*tm + 144;
}
function colorG(tm){
	return -6.2*tm + 246;
}
function colorB(tm){
	return 0.1*tm + 121;
}

var configtimedomain = {
	type: 'line',
	data: {
		labels: [],
		datasets: [{
			borderColor: '#ffb75d',
			label: 'Time Domain',
			data: [],
			fill: false,
		}]
	},
	options: {
		responsive: true,
		title: {
			display: true,
			text: 'Vibration Data'
		},
		tooltips: {
			mode: 'index',
			intersect: false,
		},
		hover: {
			mode: 'nearest',
			intersect: true
		},
		scales: {
			xAxes: [{
				display: true,
				scaleLabel: {
					display: true,
					labelString: 'Time Domain'
				}
			}],
			yAxes: [{
				display: true,
				scaleLabel: {
					display: true,
					labelString: 'Vibration(mg)'
				},
				ticks: {
					max: 1000,
					min: -1000,
					stepSize: 100
				}
			}]
		}
	}
};

var configfreqdomain = {
	type: 'line',
	data: {
		labels: [],
		datasets: [{
			borderColor: '#ffb75d',
			label: 'Frequency Domain',
			data: [],
			fill: false,
		}]
	},
	options: {
		responsive: true,
		title: {
			display: true,
			text: 'Vibration Data'
		},
		tooltips: {
			mode: 'index',
			intersect: false,
		},
		hover: {
			mode: 'nearest',
			intersect: true
		},
		scales: {
			xAxes: [{
				display: true,
				scaleLabel: {
					display: true,
					labelString: 'Frequency Domain(HZ)'
				}
			}],
			yAxes: [{
				display: true,
				scaleLabel: {
					display: true,
					labelString: 'Amplitude( )'
				}
			}]
		}
	}
};

var configcountdown = {
	type: 'doughnut',
	data: {
		datasets: [{
			data: [],
			backgroundColor: []
		}]
	},
	options: {
		elements: {
			center: {
				text: '00.0',
				color: '#FF6384', // Default is #000000
				sidePadding: 50, // Default is 20 (as a percentage)
				minFontSize: 10, // Default is 20 (in px), set to false and text will not wrap.
				lineHeight: 500 // Default is 25 (in px), used for when text wraps
			}
		},
		responsive: true,
		title: {
			display: true,
			text: 'Refresh'
		},
		animation: {
			animateScale: true,
			animateRotate: true
		},
		tooltips: {
			enabled: false
		},
		cutoutPercentage: 80,
	}
};

var configtempch0 = {
	type: 'doughnut',
	data: {
		datasets: [{
			data: [],
			backgroundColor: [
				'#d4d4d4'
			]
		}],
		labels: [
			'Celsius',
			'Buffer'
		]
	},
	options: {
		elements: {
			center: {
				text: '000.00',
				color: '#FF6384', // Default is #000000
				sidePadding: 50, // Default is 20 (as a percentage)
				minFontSize: 10, // Default is 20 (in px), set to false and text will not wrap.
				lineHeight: 500 // Default is 25 (in px), used for when text wraps
			}
		},
		responsive: true,
		legend: {
			position: 'top',
		},
		title: {
			display: true,
			text: 'Temperature'
		},
		animation: {
			animateScale: true,
			animateRotate: true
		},
		circumference: Math.PI,
		rotation: -Math.PI,
		cutoutPercentage: 80,
	}
};

var configtempch0L = {
	type: 'line',
	data: {
		labels: [],
		datasets: [{
			borderColor: '#ffb75d',
			label: 'Temperature(C)',
			data: [],
			fill: false,
		}]
	},
	options: {
		responsive: true,
		title: {
			display: true,
			text: 'Temperature Historic Data'
		},
		tooltips: {
			mode: 'index',
			intersect: false,
		},
		hover: {
			mode: 'nearest',
			intersect: true
		},
		scales: {
			xAxes: [{
				display: true,
				scaleLabel: {
					display: true,
					labelString: 'Time'
				}
			}],
			yAxes: [{
				display: true,
				scaleLabel: {
					display: true,
					labelString: 'Degree C'
				},
				ticks: {
					stepSize: 1
				}
			}]
		}
	}
}

var configedsData = {
	type: 'line',
	data: {
		labels: [],
		datasets: [{
			borderColor: '#ffb75d',
			label: 'Displacement Data',
			data: [],
			fill: false,
		}]
	},
	options: {
		responsive: true,
		title: {
			display: true,
			text: 'EDS Data'
		},
		tooltips: {
			mode: 'index',
			intersect: false,
		},
		hover: {
			mode: 'nearest',
			intersect: true
		},
		scales: {
			xAxes: [{
				display: true,
				scaleLabel: {
					display: true,
					labelString: 'Time'
				}
			}],
			yAxes: [{
				display: true,
				scaleLabel: {
					display: true,
					labelString: ''
				}
			}]
		}
	}
}


function loadDataPage(){
	timeleft = uInterval;
	$.get("http://vibr.astarc.tk/getData.php?r=TD", "json", 
		function(data){
			var jsonDecoded = JSON.parse(data);
			var int16Data = [];
			var graphLabel = [];
			$.each(jsonDecoded, function( k, v ) {
				int16Data.push(v);
				graphLabel.push(k);
			});
			configtimedomain.data.labels = graphLabel;
			configtimedomain.data.datasets[0].data = int16Data;
			if(Math.max.apply(null, int16Data) > TDScale)
				configtimedomain.options.scales.yAxes[0].ticks.max = Math.max.apply(null, int16Data) + TDScale;
			else
				configtimedomain.options.scales.yAxes[0].ticks.max = Math.max.apply(null, int16Data) + 10;
				
			if(Math.min.apply(null, int16Data) < -TDScale)
				configtimedomain.options.scales.yAxes[0].ticks.min = Math.min.apply(null, int16Data) - TDScale;
			else
				configtimedomain.options.scales.yAxes[0].ticks.min = Math.min.apply(null, int16Data) - 10;
				
			window.TD.update();
		}
	);
	$.get("http://vibr.astarc.tk/getData.php?r=FD", "json", 
		function(data){
			var jsonDecoded = JSON.parse(data);
			var int32Data = [];
			var graphLabel = [];
			$.each(jsonDecoded, function( k, v ) {
				int32Data.push(v);
				graphLabel.push(k);
			});
			configfreqdomain.data.labels = graphLabel;
			configfreqdomain.data.datasets[0].data = int32Data;
			
			window.FD.update();
		}
	);
	$.get("http://vibr.astarc.tk/getData.php?r=TP", "json", 
		function(data){
			var miscConfig = new Object();
				miscConfig.threshold1 = 70;
				miscConfig.threshold2 = 150;
				miscConfig.range1Hex = '#94f0a4';
				miscConfig.range2Hex = '#f4ca63';
				miscConfig.range3Hex = '#f29b8b';
				miscConfig.maxRange = 200;
				miscConfig.minRange = -50;
				
			var jsonDecoded = JSON.parse(data);
			
			var color0 = '';
			var color1 = '';
			if(jsonDecoded[0] < miscConfig.threshold1)
				color0 = miscConfig.range1Hex;
			else if(jsonDecoded[0] >= miscConfig.threshold1 && jsonDecoded[0] < miscConfig.threshold2)
				color0 = miscConfig.range2Hex;
			else
				color0 = miscConfig.range3Hex;
				
			configtempch0.data.datasets[0].data = [jsonDecoded[0].toFixed(1), (miscConfig.maxRange-jsonDecoded[0]).toFixed(2)];
			configtempch0.data.datasets[0].backgroundColor = [color0, '#d4d4d4'];
			configtempch0.options.elements.center.color = color0;
			configtempch0.options.elements.center.text = jsonDecoded[0].toFixed(1) + ' Â°C';
			
			window.TE0.update();
		}
	);
	$.get("http://vibr.astarc.tk/getData.php?r=TP0L", "json", 
		function(data){
			var jsonDecoded = JSON.parse(data);
			var floatData = [];
			var graphLabel = [];
			$.each(jsonDecoded, function( k, v ) {
				floatData.push(v.toFixed(1));
				graphLabel.push(k);
			});
			
			configtempch0L.data.labels = graphLabel;
			configtempch0L.data.datasets[0].data = floatData;
			
			if(Math.max.apply(null, floatData) > TPScale)
				configtempch0L.options.scales.yAxes[0].ticks.max = Math.max.apply(null, floatData) + TPScale;
			else
				configtempch0L.options.scales.yAxes[0].ticks.max = Math.max.apply(null, floatData) + 0.5;
				
			if(Math.min.apply(null, floatData) < -TPScale)
				configtempch0L.options.scales.yAxes[0].ticks.min = Math.min.apply(null, floatData) - TPScale;
			else
				configtempch0L.options.scales.yAxes[0].ticks.min = Math.min.apply(null, floatData) - 0.5;
				
			if((Math.max.apply(null, floatData) - Math.min.apply(null, floatData)) > TPDif)
				configtempch0L.options.scales.yAxes[0].ticks.stepSize = TPDif;
			else
				configtempch0L.options.scales.yAxes[0].ticks.stepSize = 0.5;
			
			window.TE0L.update();
		}
	);
	$.get("http://vibr.astarc.tk/getData.php?r=EDS", "json", 
		function(data){
			var jsonDecoded = JSON.parse(data);
			var floatData = [];
			var graphLabel = [];
			$.each(jsonDecoded, function( k, v ) {
				floatData.push(v.toFixed(1));
				graphLabel.push(k);
			});
			
			configedsData.data.labels = graphLabel;
			configedsData.data.datasets[0].data = floatData;
			
			window.EDS.update();
		}
	);
}

function renderChart(){
	window.TM = new Chart(countdown, configcountdown);
	window.TD = new Chart(timedomain, configtimedomain);
	window.FD = new Chart(freqdomain, configfreqdomain);
	window.EDS = new Chart(edsData, configedsData);
	window.TE0 = new Chart(tempch0, configtempch0);
	window.TE0L = new Chart(tempch0L, configtempch0L);
}


</script>
</head>
<body>
		<div class="uk-section uk-section-muted uk-flex uk-flex-middle uk-animation-fade crosshair" uk-height-viewport>			
			<div class="uk-width-1-1">
				<div class="uk-container uk-container-expand">
					<div class="uk-grid-margin uk-grid uk-grid-stack" uk-grid >
						<div class="uk-width-1-1 uk-margin-small">
							<div class="uk-child-width-1-4@s uk-grid-column-small uk-grid-small uk-grid-match" uk-grid>
								<div>
									<div class="uk-card uk-card-default uk-card-body uk-card-hover uk-card-small">
										<canvas id="countdown"></canvas>
									</div>
								</div>
								<div>
									<div class="uk-card uk-card-default uk-card-body uk-card-hover uk-card-small">
										<canvas id="tempch0"></canvas>
									</div>
								</div>
								<div>
									<div class="uk-card uk-card-default uk-card-body uk-card-hover uk-card-small">
										<canvas id="tempch0L"></canvas>
									</div>
								</div>
								<div>
									<div class="uk-card uk-card-default uk-card-body uk-card-hover uk-card-small">
										<canvas id="edsData"></canvas>
									</div>
								</div>
							</div>
						</div>
						<div class="uk-width-1-1 uk-margin-small">
							<div class="uk-child-width-1-2@s uk-grid-column-small uk-grid-small uk-grid-match" uk-grid>
								<div>
									<div class="uk-card uk-card-default uk-card-body uk-card-hover uk-card-small">
										<canvas id="timedomain"></canvas>
									</div>
								</div>
								<div>
									<div class="uk-card uk-card-default uk-card-body uk-card-hover uk-card-small">
										<canvas id="freqdomain"></canvas>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="uk-width-1-1 uk-margin-small uk-text-center">
							<div class="uk-background-muted uk-padding">
								<p class="uk-text-large ">
									LeadWell Vibration Monitor System
								</p>
							</div>
					</div>
				</div>
			</div>
		</div>
</body>
</html>
